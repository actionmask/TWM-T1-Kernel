/* Copyright (c) 2009, Quanta. All rights reserved.
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License version 2 and
 * only version 2 as published by the Free Software Foundation.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
 * 02110-1301, USA.
 *
 */

#include <linux/delay.h>
#include <linux/types.h>
#include <linux/i2c.h>
#include <linux/uaccess.h>
#include <linux/miscdevice.h>
#include <media/msm_camera.h>
#include <mach/gpio.h>
#include "ov3640.h"
#include <linux/earlysuspend.h>
uint8_t preview_flag = 0;
static uint16_t RegAddrVal_3355 = 0x00;
static uint16_t RegAddrVal_3354 = 0x01;
static uint16_t RegAddrVal_3302 = 0xcf;
static uint16_t RegAddrVal_3014 = 0x0c;
static uint16_t RegAddrVal_3013 = 0xf7;
static uint16_t RegAddrVal_30d7 = 0x90;
static uint16_t RegAddrVal_304c = 0x82;

/* Micron OV3640 Registers and their values */
/* Sensor Core Registers */
#define  REG_OV3640_MODEL_ID 0x3000
#define  OV3640_MODEL_ID     0x1580

/*  SOC Registers Page 1  */
#define  REG_OV3640_SENSOR_RESET     0x301A
#define  REG_OV3640_STANDBY_CONTROL  0x3202
#define  REG_OV3640_MCU_BOOT         0x3386

struct ov3640_work {
	struct work_struct work;
};

static struct  ov3640_work *ov3640_sensorw;
static struct  i2c_client *ov3640_client;

struct ov3640_ctrl {
	const struct msm_camera_sensor_info *sensordata;
};

bool autofocus_firmware_download = 0;
uint8_t ov3640_auto_focus_reg_firmware_array[] = {
0x80, 
0x00, 
0x02,
0x07,
0x88,
0x02,
0x09,
0x9A,
0x85,
0x3C,
0x27,
0x85,
0x3D,
0x28,
0x85,
0x3E,
0x2B,
0x85,
0x3F,
0x2C,
0xE5,
0x24,
0x14,
0x70,
0x03,
0x02,
0x00,
0xA7,
0x14,
0x70,
0x03,
0x02,
0x01,
0x45,
0x14,
0x70,
0x03,
0x02,
0x01,
0xEC,
0x24,
0x03,
0x60,
0x03,
0x02,
0x02,
0x42,
0xE5,
0x48,
0x45,
0x47,
0x70,
0x12,
0x85,
0x27,
0x25,
0x85,
0x28,
0x26,
0x85,
0x2B,
0x29,
0x85,
0x2C,
0x2A,
0xF5,
0x22,
0xF5,
0x23,
0x80,
0x1D,
0xC3,
0xE5,
0x2C,
0x95,
0x2A,
0xE5,
0x2B,
0x95,
0x29,
0x40,
0x12,
0x85,
0x27,
0x25,
0x85,
0x28,
0x26,
0x85,
0x2B,
0x29,
0x85,
0x2C,
0x2A,
0x85,
0x47,
0x22,
0x85,
0x48,
0x23,
0xE5,
0x48,
0x45,
0x47,
0x70,
0x08,
0x85,
0x35,
0x47,
0x85,
0x36,
0x48,
0x80,
0x1A,
0xC3,
0xE5,
0x48,
0x95,
0x4A,
0xE5,
0x47,
0x95,
0x49,
0x50,
0x04,
0xE5,
0x3B,
0x80,
0x02,
0xE5,
0x4B,
0x25,
0x48,
0xF5,
0x48,
0xE4,
0x35,
0x47,
0xF5,
0x47,
0x85,
0x47,
0x12,
0x85,
0x48,
0x13,
0x12,
0x0B,
0x66,
0xD3,
0xE5,
0x48,
0x95,
0x4A,
0xE5,
0x47,
0x95,
0x49,
0x50,
0x03,
0x02,
0x02,
0x42,
0x75,
0x24,
0x01,
0x02,
0x02,
0x42,
0xC3,
0xE5,
0x2C,
0x95,
0x2A,
0xFF,
0xE5,
0x2B,
0x95,
0x29,
0xFE,
0x12,
0x0D,
0x6B,
0xC0,
0x06,
0xC0,
0x07,
0xC3,
0xE5,
0x28,
0x95,
0x26,
0xFF,
0xE5,
0x27,
0x95,
0x25,
0xFE,
0x12,
0x0D,
0x6B,
0xD0,
0x05,
0xD0,
0x04,
0xD3,
0xEF,
0x9D,
0xEC,
0x64,
0x80,
0xF8,
0xEE,
0x64,
0x80,
0x98,
0x40,
0x0E,
0x85,
0x27,
0x2D,
0x85,
0x28,
0x2E,
0x85,
0x25,
0x2F,
0x85,
0x26,
0x30,
0x80,
0x0C,
0x85,
0x2B,
0x2D,
0x85,
0x2C,
0x2E,
0x85,
0x29,
0x2F,
0x85,
0x2A,
0x30,
0xC3,
0xE5,
0x2E,
0x95,
0x30,
0xE5,
0x2D,
0x95,
0x2F,
0x40,
0x30,
0xAF,
0x4B,
0x7E,
0x00,
0xE5,
0x48,
0x2F,
0xFD,
0xEE,
0x35,
0x47,
0xFC,
0xC3,
0xED,
0x95,
0x4D,
0xEC,
0x95,
0x4C,
0x50,
0x18,
0xEF,
0x25,
0x48,
0xF5,
0x48,
0xEE,
0x35,
0x47,
0xF5,
0x47,
0xF5,
0x12,
0x85,
0x48,
0x13,
0x12,
0x0B,
0x66,
0x75,
0x24,
0x02,
0x02,
0x01,
0xC2,
0x02,
0x01,
0xD0,
0x85,
0x47,
0x0C,
0x85,
0x48,
0x0D,
0x85,
0x22,
0x0E,
0x85,
0x23,
0x0F,
0x12,
0x0B,
0x21,
0x85,
0x22,
0x47,
0x85,
0x23,
0x48,
0x02,
0x01,
0xE7,
0xC3,
0xE5,
0x2C,
0x95,
0x2A,
0xFF,
0xE5,
0x2B,
0x95,
0x29,
0xFE,
0x12,
0x0D,
0x6B,
0xC0,
0x06,
0xC0,
0x07,
0xC3,
0xE5,
0x28,
0x95,
0x26,
0xFF,
0xE5,
0x27,
0x95,
0x25,
0xFE,
0x12,
0x0D,
0x6B,
0xD0,
0x05,
0xD0,
0x04,
0xD3,
0xEF,
0x9D,
0xEC,
0x64,
0x80,
0xF8,
0xEE,
0x64,
0x80,
0x98,
0x40,
0x0E,
0x85,
0x27,
0x2D,
0x85,
0x28,
0x2E,
0x85,
0x25,
0x2F,
0x85,
0x26,
0x30,
0x80,
0x0C,
0x85,
0x2B,
0x2D,
0x85,
0x2C,
0x2E,
0x85,
0x29,
0x2F,
0x85,
0x2A,
0x30,
0xC3,
0xE5,
0x2E,
0x95,
0x30,
0xE5,
0x2D,
0x95,
0x2F,
0x40,
0x37,
0xAF,
0x4B,
0x7E,
0x00,
0xE5,
0x48,
0x2F,
0xFD,
0xEE,
0x35,
0x47,
0xFC,
0xC3,
0xED,
0x95,
0x4D,
0xEC,
0x95,
0x4C,
0x50,
0x20,
0xEF,
0x25,
0x48,
0xF5,
0x48,
0xEE,
0x35,
0x47,
0xF5,
0x47,
0xF5,
0x12,
0x85,
0x48,
0x13,
0x12,
0x0B,
0x66,
0x85,
0x27,
0x25,
0x85,
0x28,
0x26,
0x85,
0x2B,
0x29,
0x85,
0x2C,
0x2A,
0x80,
0x72,
0x80,
0x15,
0xC3,
0xE5,
0x48,
0x95,
0x4B,
0xF5,
0x48,
0xE5,
0x47,
0x94,
0x00,
0xF5,
0x47,
0xF5,
0x12,
0x85,
0x48,
0x13,
0x12,
0x0B,
0x66,
0x75,
0x24,
0x03,
0x80,
0x56,
0xE4,
0xF5,
0x24,
0xC3,
0xE5,
0x42,
0x95,
0x30,
0xE5,
0x41,
0x95,
0x2F,
0x50,
0x23,
0xE5,
0x40,
0x54,
0x0C,
0xFF,
0xBF,
0x04,
0x05,
0x75,
0x40,
0x46,
0x80,
0x32,
0xEF,
0x64,
0x08,
0x70,
0x2D,
0x75,
0x40,
0x4A,
0x85,
0x3C,
0x43,
0x85,
0x3D,
0x44,
0x85,
0x3E,
0x45,
0x85,
0x3F,
0x46,
0x80,
0x1C,
0xE5,
0x40,
0x54,
0x0C,
0xFF,
0xBF,
0x04,
0x05,
0x75,
0x40,
0xC6,
0x80,
0x0F,
0xBF,
0x08,
0x0C,
0x75,
0x40,
0xCA,
0xE4,
0xF5,
0x43,
0xF5,
0x44,
0xF5,
0x45,
0xF5,
0x46,
0x12,
0x0A,
0x07,
0x90,
0x3F,
0x01,
0xE5,
0x40,
0xF0,
0xC2,
0x0A,
0x22,
0xE5,
0x13,
0xD3,
0x94,
0x04,
0x40,
0x03,
0xE4,
0xF5,
0x13,
0xE5,
0x13,
0x25,
0xE0,
0x25,
0xE0,
0xF5,
0x13,
0xE5,
0x10,
0xAE,
0x0F,
0x78,
0x05,
0xCE,
0xC3,
0x13,
0xCE,
0x13,
0xD8,
0xF9,
0xFB,
0xAA,
0x06,
0x25,
0xE0,
0xFF,
0xEA,
0x33,
0xFE,
0xEF,
0x78,
0x03,
0xCE,
0xC3,
0x13,
0xCE,
0x13,
0xD8,
0xF9,
0xF5,
0x1C,
0xE5,
0x12,
0xAE,
0x11,
0x78,
0x03,
0xCE,
0xC3,
0x13,
0xCE,
0x13,
0xD8,
0xF9,
0x25,
0xE0,
0xFF,
0xEE,
0x33,
0xFE,
0xEF,
0x78,
0x03,
0xCE,
0xC3,
0x13,
0xCE,
0x13,
0xD8,
0xF9,
0xF9,
0x7C,
0x00,
0x7D,
0x06,
0xAF,
0x03,
0xAE,
0x02,
0x12,
0x06,
0xFB,
0xEF,
0x78,
0x03,
0xCE,
0xC3,
0x13,
0xCE,
0x13,
0xD8,
0xF9,
0xFB,
0xE5,
0x12,
0xAE,
0x11,
0x78,
0x03,
0xCE,
0xC3,
0x13,
0xCE,
0x13,
0xD8,
0xF9,
0xFF,
0x7C,
0x00,
0x7D,
0x06,
0x12,
0x06,
0xFB,
0xEF,
0x78,
0x03,
0xCE,
0xC3,
0x13,
0xCE,
0x13,
0xD8,
0xF9,
0xFD,
0xE5,
0x1C,
0x75,
0xF0,
0x20,
0xA4,
0x85,
0xF0,
0x14,
0xF5,
0x15,
0xE9,
0x75,
0xF0,
0x08,
0xA4,
0x85,
0xF0,
0x16,
0xF5,
0x17,
0xEB,
0x75,
0xF0,
0x20,
0xA4,
0x85,
0xF0,
0x18,
0xF5,
0x19,
0xAF,
0x05,
0xEF,
0x75,
0xF0,
0x08,
0xA4,
0xFB,
0xAA,
0xF0,
0xE5,
0x14,
0x54,
0x0F,
0xFD,
0xE5,
0x16,
0x54,
0x07,
0xC4,
0xF8,
0x54,
0xF0,
0xC8,
0xE4,
0xC4,
0x54,
0x0F,
0x48,
0x2D,
0xF5,
0x1D,
0xE5,
0x18,
0x54,
0x0F,
0xFD,
0xEA,
0x54,
0x07,
0xC4,
0xF8,
0x54,
0xF0,
0xC8,
0xE4,
0xC4,
0x54,
0x0F,
0x48,
0x2D,
0xF5,
0x1E,
0x90,
0x30,
0x24,
0xE0,
0xFF,
0x7E,
0x00,
0xA3,
0xE0,
0x24,
0x08,
0xFD,
0xEF,
0xA8,
0x05,
0x08,
0x80,
0x05,
0xC3,
0x33,
0xCE,
0x33,
0xCE,
0xD8,
0xF9,
0xF5,
0x1B,
0x8E,
0x1A,
0x90,
0x30,
0x88,
0xE0,
0xFF,
0x7E,
0x00,
0xA3,
0xE0,
0x24,
0x08,
0xFD,
0xEF,
0xA8,
0x05,
0x08,
0x80,
0x05,
0xC3,
0x33,
0xCE,
0x33,
0xCE,
0xD8,
0xF9,
0xFF,
0xAC,
0x06,
0xFD,
0xAE,
0x1A,
0xAF,
0x1B,
0x12,
0x07,
0x0D,
0x90,
0x30,
0x12,
0xE0,
0x70,
0x2E,
0xD3,
0xEF,
0x94,
0x03,
0xEE,
0x94,
0x00,
0x90,
0x39,
0x0A,
0x50,
0x11,
0x74,
0x18,
0xF0,
0xA3,
0x74,
0x48,
0xF0,
0xA3,
0x74,
0x28,
0xF0,
0xA3,
0x74,
0x78,
0xF0,
0x80,
0x23,
0x74,
0x1B,
0xF0,
0xA3,
0x74,
0x40,
0xF0,
0xA3,
0x74,
0x25,
0xF0,
0xA3,
0x74,
0x70,
0xF0,
0x80,
0x12,
0x90,
0x39,
0x0A,
0x74,
0x0C,
0xF0,
0xA3,
0x74,
0x24,
0xF0,
0xA3,
0x74,
0x14,
0xF0,
0xA3,
0x74,
0x3C,
0xF0,
0x90,
0x33,
0xAA,
0xE5,
0x1D,
0xF0,
0xE5,
0x15,
0xA3,
0xF0,
0xE5,
0x17,
0xA3,
0xF0,
0xA3,
0xE5,
0x1E,
0xF0,
0xE5,
0x19,
0xA3,
0xF0,
0xEB,
0xA3,
0xF0,
0x22,
0x90,
0x3F,
0x00,
0xE0,
0x54,
0x3F,
0xF5,
0x0B,
0xE0,
0x54,
0xC0,
0xF0,
0xE5,
0x0B,
0x12,
0x07,
0x62,
0x04,
0x07,
0x00,
0x04,
0x18,
0x01,
0x04,
0x23,
0x02,
0x04,
0x2E,
0x03,
0x04,
0x41,
0x04,
0x04,
0x55,
0x05,
0x04,
0x68,
0x06,
0x04,
0x81,
0x07,
0x04,
0x9E,
0x08,
0x04,
0xC6,
0x10,
0x04,
0xC6,
0x11,
0x04,
0xC6,
0x12,
0x04,
0xC6,
0x13,
0x04,
0xC6,
0x14,
0x04,
0xC6,
0x15,
0x04,
0xD6,
0x20,
0x00,
0x00,
0x04,
0xEA,
0xE5,
0x4E,
0x70,
0x03,
0x02,
0x04,
0xEA,
0xE5,
0x40,
0x60,
0x03,
0x02,
0x04,
0xEA,
0x02,
0x04,
0x99,
0xD2,
0x09,
0x75,
0x0D,
0x01,
0x12,
0x0D,
0x57,
0x02,
0x04,
0xEA,
0xE4,
0xF5,
0x0D,
0x12,
0x0D,
0x57,
0xC2,
0x09,
0x02,
0x04,
0xEA,
0xE5,
0x40,
0x60,
0x03,
0x02,
0x04,
0xEA,
0xE5,
0x4E,
0x60,
0x03,
0x02,
0x04,
0xEA,
0x75,
0x40,
0x65,
0x80,
0x7D,
0xE5,
0x40,
0x60,
0x03,
0x02,
0x04,
0xEA,
0xE5,
0x4E,
0x60,
0x03,
0x02,
0x04,
0xEA,
0x75,
0x4E,
0x01,
0x02,
0x04,
0xEA,
0xE5,
0x40,
0x60,
0x03,
0x02,
0x04,
0xEA,
0xE5,
0x4E,
0x60,
0x03,
0x02,
0x04,
0xEA,
0x75,
0x40,
0x4E,
0x80,
0x56,
0xE5,
0x40,
0xB4,
0x46,
0x09,
0x75,
0x40,
0x47,
0x85,
0x40,
0x0C,
0x12,
0x0A,
0x0A,
0xE5,
0x40,
0x64,
0x4A,
0x70,
0x6E,
0x75,
0x40,
0x4B,
0x80,
0x3D,
0xE5,
0x40,
0x64,
0x4B,
0x70,
0x63,
0x85,
0x47,
0x0C,
0x85,
0x48,
0x0D,
0xF5,
0x0E,
0xF5,
0x0F,
0x12,
0x0B,
0x21,
0xE4,
0xF5,
0x47,
0xF5,
0x48,
0x75,
0x40,
0x69,
0x80,
0x20,
0xE5,
0x40,
0x54,
0x03,
0xC3,
0x94,
0x02,
0x40,
0x43,
0xE4,
0xF5,
0x40,
0xF5,
0x4E,
0x85,
0x47,
0x0C,
0x85,
0x48,
0x0D,
0xF5,
0x0E,
0xF5,
0x0F,
0x12,
0x0B,
0x21,
0xE4,
0xF5,
0x47,
0xF5,
0x48,
0x85,
0x40,
0x0C,
0x12,
0x0A,
0x0A,
0x80,
0x24,
0xE5,
0x4E,
0x70,
0x20,
0xE5,
0x40,
0x70,
0x1C,
0x85,
0x0B,
0x0C,
0x12,
0x06,
0x60,
0x80,
0x14,
0xE5,
0x3C,
0x90,
0x3F,
0x02,
0xF0,
0xA3,
0xE5,
0x3D,
0xF0,
0xE5,
0x3E,
0xA3,
0xF0,
0x90,
0x3F,
0x07,
0xE5,
0x3F,
0xF0,
0x90,
0x3F,
0x01,
0xE5,
0x40,
0xF0,
0x22,
0x90,
0x33,
0x62,
0xE0,
0x54,
0x0F,
0xFE,
0xA3,
0xE0,
0x7C,
0x00,
0x24,
0x00,
0xF5,
0x0C,
0xEC,
0x3E,
0xF5,
0x0B,
0x90,
0x33,
0x62,
0xE0,
0x54,
0x70,
0x75,
0xF0,
0x10,
0xA4,
0xFF,
0xAE,
0xF0,
0x90,
0x33,
0x64,
0xE0,
0x2F,
0xF5,
0x0E,
0xEC,
0x3E,
0xF5,
0x0D,
0xE5,
0x51,
0xB5,
0x0C,
0x11,
0xE5,
0x50,
0xB5,
0x0B,
0x0C,
0xE5,
0x53,
0x65,
0x0E,
0x70,
0x04,
0xE5,
0x52,
0x65,
0x0D,
0x60,
0x1E,
0x85,
0x0B,
0x50,
0x85,
0x0C,
0x51,
0x85,
0x0D,
0x52,
0x85,
0x0E,
0x53,
0x85,
0x0B,
0x0F,
0x85,
0x0C,
0x10,
0x85,
0x0D,
0x11,
0x85,
0x0E,
0x12,
0xE4,
0xF5,
0x13,
0x12,
0x02,
0x45,
0x90,
0x33,
0x65,
0xE0,
0x30,
0xE3,
0x35,
0x90,
0x33,
0xA4,
0xE0,
0x54,
0x0F,
0xFC,
0xA3,
0xE0,
0x75,
0xF0,
0x04,
0xA4,
0xAE,
0xF0,
0x24,
0x00,
0xF5,
0x0C,
0xEE,
0x3C,
0xF5,
0x0B,
0x90,
0x33,
0xA4,
0xE0,
0x54,
0x70,
0x75,
0xF0,
0x10,
0xA4,
0xFD,
0xAC,
0xF0,
0x90,
0x33,
0xA6,
0xE0,
0x75,
0xF0,
0x04,
0xA4,
0xAE,
0xF0,
0x2D,
0xF5,
0x0E,
0xEE,
0x3C,
0xF5,
0x0D,
0xE5,
0x55,
0xB5,
0x0C,
0x11,
0xE5,
0x54,
0xB5,
0x0B,
0x0C,
0xE5,
0x57,
0x65,
0x0E,
0x70,
0x04,
0xE5,
0x56,
0x65,
0x0D,
0x60,
0x1B,
0x85,
0x0B,
0x54,
0x85,
0x0C,
0x55,
0x85,
0x0D,
0x56,
0x85,
0x0E,
0x57,
0x85,
0x0B,
0x0F,
0x85,
0x0C,
0x10,
0x85,
0x0D,
0x11,
0x85,
0x0E,
0x12,
0x12,
0x05,
0xBE,
0x22,
0xE5,
0x10,
0x25,
0xE0,
0xFF,
0xE5,
0x0F,
0x33,
0xFE,
0xEF,
0x78,
0x03,
0xCE,
0xC3,
0x13,
0xCE,
0x13,
0xD8,
0xF9,
0xF5,
0x14,
0x8E,
0x13,
0xE5,
0x12,
0x25,
0xE0,
0xFF,
0xE5,
0x11,
0x33,
0xFE,
0xEF,
0x78,
0x03,
0xCE,
0xC3,
0x13,
0xCE,
0x13,
0xD8,
0xF9,
0xF5,
0x16,
0x8E,
0x15,
0xAE,
0x0F,
0xAF,
0x10,
0x7C,
0x00,
0x7D,
0x06,
0x12,
0x06,
0xFB,
0xEF,
0x78,
0x03,
0xCE,
0xC3,
0x13,
0xCE,
0x13,
0xD8,
0xF9,
0xF5,
0x18,
0x8E,
0x17,
0xAE,
0x11,
0xAF,
0x12,
0x7C,
0x00,
0x7D,
0x06,
0x12,
0x06,
0xFB,
0xEF,
0x78,
0x03,
0xCE,
0xC3,
0x13,
0xCE,
0x13,
0xD8,
0xF9,
0xFD,
0xAC,
0x06,
0xE5,
0x13,
0x54,
0x0F,
0xFB,
0xE5,
0x15,
0x54,
0x07,
0xC4,
0xF8,
0x54,
0xF0,
0xC8,
0xE4,
0xC4,
0x54,
0x0F,
0x48,
0x2B,
0xFB,
0xE5,
0x17,
0x54,
0x0F,
0xFA,
0xEC,
0x54,
0x07,
0xC4,
0xF8,
0x54,
0xF0,
0xC8,
0xE4,
0xC4,
0x54,
0x0F,
0x48,
0x2A,
0xFF,
0x90,
0x33,
0xAA,
0xEB,
0xF0,
0xE5,
0x14,
0xA3,
0xF0,
0xE5,
0x16,
0xA3,
0xF0,
0xA3,
0xEF,
0xF0,
0xE5,
0x18,
0xA3,
0xF0,
0xAF,
0x05,
0xEF,
0xA3,
0xF0,
0x22,
0xE5,
0x0C,
0x30,
0xE7,
0x55,
0x54,
0x7F,
0xF5,
0x3B,
0x90,
0x3F,
0x01,
0xE0,
0xF5,
0x4B,
0xA3,
0xE0,
0x75,
0x35,
0x00,
0xF5,
0x36,
0xA3,
0xE0,
0x75,
0x49,
0x00,
0xF5,
0x4A,
0xA3,
0xE0,
0x75,
0x4C,
0x00,
0xF5,
0x4D,
0x75,
0x4D,
0x00,
0xF5,
0x4C,
0xA3,
0xE0,
0x25,
0x4D,
0xF5,
0x4D,
0xE4,
0x35,
0x4C,
0xF5,
0x4C,
0xE5,
0x36,
0x25,
0xE0,
0xF5,
0x36,
0xE5,
0x35,
0x33,
0xF5,
0x35,
0xE5,
0x4A,
0x25,
0xE0,
0xF5,
0x4A,
0xE5,
0x49,
0x33,
0xF5,
0x49,
0x90,
0x3F,
0x00,
0xE4,
0xF0,
0xA3,
0xF0,
0xA3,
0xF0,
0xA3,
0xF0,
0xA3,
0xF0,
0xA3,
0xF0,
0x22,
0x90,
0x3F,
0x02,
0xE0,
0xFF,
0x7E,
0x00,
0x7F,
0x00,
0xFE,
0xA3,
0xE0,
0x2F,
0xFF,
0xE4,
0x3E,
0xFE,
0xE5,
0x0C,
0x24,
0xEF,
0x60,
0x13,
0x14,
0x60,
0x13,
0x14,
0x60,
0x15,
0x14,
0x60,
0x17,
0x14,
0x60,
0x19,
0x24,
0x05,
0x70,
0x19,
0x8F,
0x3B,
0x22,
0x8F,
0x4B,
0x22,
0x8E,
0x35,
0x8F,
0x36,
0x22,
0x8E,
0x49,
0x8F,
0x4A,
0x22,
0x8E,
0x4C,
0x8F,
0x4D,
0x22,
0x8E,
0x41,
0x8F,
0x42,
0x22,
0xEF,
0x8D,
0xF0,
0xA4,
0xA8,
0xF0,
0xCF,
0x8C,
0xF0,
0xA4,
0x28,
0xCE,
0x8D,
0xF0,
0xA4,
0x2E,
0xFE,
0x22,
0xBC,
0x00,
0x0B,
0xBE,
0x00,
0x29,
0xEF,
0x8D,
0xF0,
0x84,
0xFF,
0xAD,
0xF0,
0x22,
0xE4,
0xCC,
0xF8,
0x75,
0xF0,
0x08,
0xEF,
0x2F,
0xFF,
0xEE,
0x33,
0xFE,
0xEC,
0x33,
0xFC,
0xEE,
0x9D,
0xEC,
0x98,
0x40,
0x05,
0xFC,
0xEE,
0x9D,
0xFE,
0x0F,
0xD5,
0xF0,
0xE9,
0xE4,
0xCE,
0xFD,
0x22,
0xED,
0xF8,
0xF5,
0xF0,
0xEE,
0x84,
0x20,
0xD2,
0x1C,
0xFE,
0xAD,
0xF0,
0x75,
0xF0,
0x08,
0xEF,
0x2F,
0xFF,
0xED,
0x33,
0xFD,
0x40,
0x07,
0x98,
0x50,
0x06,
0xD5,
0xF0,
0xF2,
0x22,
0xC3,
0x98,
0xFD,
0x0F,
0xD5,
0xF0,
0xEA,
0x22,
0xD0,
0x83,
0xD0,
0x82,
0xF8,
0xE4,
0x93,
0x70,
0x12,
0x74,
0x01,
0x93,
0x70,
0x0D,
0xA3,
0xA3,
0x93,
0xF8,
0x74,
0x01,
0x93,
0xF5,
0x82,
0x88,
0x83,
0xE4,
0x73,
0x74,
0x02,
0x93,
0x68,
0x60,
0xEF,
0xA3,
0xA3,
0xA3,
0x80,
0xDF,
0x78,
0x7F,
0xE4,
0xF6,
0xD8,
0xFD,
0x75,
0x81,
0x5C,
0x02,
0x07,
0xCF,
0x02,
0x0B,
0xDB,
0xE4,
0x93,
0xA3,
0xF8,
0xE4,
0x93,
0xA3,
0x40,
0x03,
0xF6,
0x80,
0x01,
0xF2,
0x08,
0xDF,
0xF4,
0x80,
0x29,
0xE4,
0x93,
0xA3,
0xF8,
0x54,
0x07,
0x24,
0x0C,
0xC8,
0xC3,
0x33,
0xC4,
0x54,
0x0F,
0x44,
0x20,
0xC8,
0x83,
0x40,
0x04,
0xF4,
0x56,
0x80,
0x01,
0x46,
0xF6,
0xDF,
0xE4,
0x80,
0x0B,
0x01,
0x02,
0x04,
0x08,
0x10,
0x20,
0x40,
0x80,
0x90,
0x0D,
0x7D,
0xE4,
0x7E,
0x01,
0x93,
0x60,
0xBC,
0xA3,
0xFF,
0x54,
0x3F,
0x30,
0xE5,
0x09,
0x54,
0x1F,
0xFE,
0xE4,
0x93,
0xA3,
0x60,
0x01,
0x0E,
0xCF,
0x54,
0xC0,
0x25,
0xE0,
0x60,
0xA8,
0x40,
0xB8,
0xE4,
0x93,
0xA3,
0xFA,
0xE4,
0x93,
0xA3,
0xF8,
0xE4,
0x93,
0xA3,
0xC8,
0xC5,
0x82,
0xC8,
0xCA,
0xC5,
0x83,
0xCA,
0xF0,
0xA3,
0xC8,
0xC5,
0x82,
0xC8,
0xCA,
0xC5,
0x83,
0xCA,
0xDF,
0xE9,
0xDE,
0xE7,
0x80,
0xBE,
0x90,
0x3F,
0x07,
0xE0,
0x75,
0xF0,
0x04,
0xA4,
0xF5,
0x42,
0x85,
0xF0,
0x41,
0xE5,
0x31,
0xD3,
0x94,
0x02,
0x40,
0x4D,
0xE5,
0x3D,
0x95,
0x34,
0xFF,
0xE5,
0x3C,
0x95,
0x33,
0xFE,
0x12,
0x0D,
0x6B,
0xD3,
0xEF,
0x95,
0x42,
0xEE,
0x95,
0x41,
0x50,
0x05,
0x12,
0x0C,
0xD5,
0x50,
0x0A,
0x85,
0x3C,
0x33,
0x85,
0x3D,
0x34,
0xE4,
0xF5,
0x32,
0x22,
0x05,
0x32,
0xE5,
0x32,
0xD3,
0x94,
0x02,
0x40,
0x47,
0xE4,
0xF5,
0x31,
0xF5,
0x32,
0x75,
0x40,
0x69,
0xF5,
0x47,
0xF5,
0x48,
0x85,
0x47,
0x12,
0x85,
0x48,
0x13,
0x12,
0x0B,
0x66,
0x12,
0x0A,
0x07,
0x90,
0x3F,
0x01,
0xE5,
0x40,
0xF0,
0x22,
0xC3,
0xE5,
0x3D,
0x95,
0x44,
0xFF,
0xE5,
0x3C,
0x95,
0x43,
0xFE,
0x12,
0x0D,
0x6B,
0xD3,
0xEF,
0x95,
0x42,
0xEE,
0x95,
0x41,
0x50,
0x05,
0x12,
0x0C,
0xD5,
0x50,
0x09,
0x05,
0x31,
0x85,
0x3C,
0x33,
0x85,
0x3D,
0x34,
0x22,
0xE4,
0xF5,
0x31,
0x22,
0xE5,
0x09,
0x70,
0x36,
0xE5,
0x08,
0x75,
0xF0,
0x08,
0xA4,
0xFF,
0x24,
0x80,
0x90,
0x3A,
0x00,
0xF0,
0x90,
0x3A,
0x03,
0xE0,
0xF5,
0x0A,
0xEF,
0x24,
0x81,
0x90,
0x3A,
0x00,
0xF0,
0x90,
0x3A,
0x03,
0xE0,
0xFC,
0xE5,
0x08,
0x75,
0xF0,
0x08,
0xA4,
0xFF,
0x24,
0x82,
0x90,
0x3A,
0x00,
0xF0,
0x90,
0x3A,
0x03,
0xE0,
0xFD,
0xEF,
0x24,
0x83,
0x80,
0x3A,
0xE5,
0x09,
0x64,
0x01,
0x70,
0x3C,
0xE5,
0x08,
0x75,
0xF0,
0x08,
0xA4,
0xFF,
0x24,
0x84,
0x90,
0x3A,
0x00,
0xF0,
0x90,
0x3A,
0x03,
0xE0,
0xF5,
0x0A,
0xEF,
0x24,
0x85,
0x90,
0x3A,
0x00,
0xF0,
0x90,
0x3A,
0x03,
0xE0,
0xFC,
0xE5,
0x08,
0x75,
0xF0,
0x08,
0xA4,
0xFF,
0x24,
0x86,
0x90,
0x3A,
0x00,
0xF0,
0x90,
0x3A,
0x03,
0xE0,
0xFD,
0xEF,
0x24,
0x87,
0x90,
0x3A,
0x00,
0xF0,
0x90,
0x3A,
0x03,
0xE0,
0xED,
0xFE,
0xEC,
0xFB,
0xEB,
0xFF,
0x22,
0x7E,
0x08,
0xE5,
0x17,
0x33,
0x92,
0x01,
0x90,
0x30,
0xB4,
0xE5,
0x20,
0xF0,
0x7F,
0x0A,
0xAD,
0x07,
0x1F,
0xED,
0x70,
0xFA,
0xE5,
0x17,
0x25,
0xE0,
0xF5,
0x17,
0xD2,
0x00,
0x90,
0x30,
0xB4,
0xE5,
0x20,
0xF0,
0x7F,
0x0A,
0xAD,
0x07,
0x1F,
0xED,
0x70,
0xFA,
0xC2,
0x00,
0x90,
0x30,
0xB4,
0xE5,
0x20,
0xF0,
0xDE,
0xCD,
0x90,
0x30,
0xB1,
0xE0,
0x54,
0x7F,
0xF0,
0x7F,
0x05,
0xAE,
0x07,
0x1F,
0xEE,
0x70,
0xFA,
0xD2,
0x00,
0x90,
0x30,
0xB4,
0xE5,
0x20,
0xF0,
0x7F,
0x05,
0xAE,
0x07,
0x1F,
0xEE,
0x70,
0xFA,
0x90,
0x30,
0xB5,
0xE0,
0x54,
0x02,
0xFE,
0xC2,
0x00,
0x90,
0x30,
0xB4,
0xE5,
0x20,
0xF0,
0x90,
0x30,
0xB1,
0xE0,
0x44,
0x80,
0xF0,
0x7F,
0x05,
0xAD,
0x07,
0x1F,
0xED,
0x70,
0xFA,
0xBE,
0x02,
0x02,
0xC3,
0x22,
0xD3,
0x22,
0xC0,
0xE0,
0xC0,
0xF0,
0xC0,
0x83,
0xC0,
0x82,
0xC0,
0xD0,
0x75,
0xD0,
0x00,
0xC0,
0x00,
0xC0,
0x01,
0xC0,
0x02,
0xC0,
0x03,
0xC0,
0x04,
0xC0,
0x05,
0xC0,
0x06,
0xC0,
0x07,
0x90,
0x37,
0x08,
0xE0,
0x30,
0xE3,
0x2E,
0x85,
0x3C,
0x37,
0x85,
0x3D,
0x38,
0x85,
0x3E,
0x39,
0x85,
0x3F,
0x3A,
0x75,
0x08,
0x00,
0x75,
0x09,
0x00,
0x12,
0x08,
0x9E,
0x8E,
0x3C,
0x8F,
0x3D,
0x75,
0x08,
0x00,
0x75,
0x09,
0x01,
0x12,
0x08,
0x9E,
0x8E,
0x3E,
0x8F,
0x3F,
0x90,
0x37,
0x08,
0x74,
0x08,
0xF0,
0xD2,
0x0A,
0xD0,
0x07,
0xD0,
0x06,
0xD0,
0x05,
0xD0,
0x04,
0xD0,
0x03,
0xD0,
0x02,
0xD0,
0x01,
0xD0,
0x00,
0xD0,
0xD0,
0xD0,
0x82,
0xD0,
0x83,
0xD0,
0xF0,
0xD0,
0xE0,
0x32,
0x85,
0x40,
0x0C,
0xE5,
0x0C,
0x12,
0x07,
0x62,
0x0A,
0x34,
0x00,
0x0A,
0x36,
0x46,
0x0A,
0x34,
0x47,
0x0A,
0x36,
0x4A,
0x0A,
0x34,
0x4B,
0x0A,
0x34,
0x4E,
0x0A,
0x51,
0x65,
0x0A,
0x51,
0x69,
0x0A,
0x34,
0x80,
0x0A,
0x42,
0xC6,
0x0A,
0x42,
0xCA,
0x00,
0x00,
0x0A,
0x34,
0x80,
0x30,
0x90,
0x33,
0xB3,
0xE4,
0xF0,
0xA3,
0xF0,
0xA3,
0xF0,
0xA3,
0x80,
0x1E,
0x90,
0x33,
0xB3,
0xE4,
0xF0,
0xA3,
0xF0,
0xA3,
0x74,
0xFF,
0xF0,
0xA3,
0xE4,
0x80,
0x0F,
0x90,
0x33,
0xB3,
0x74,
0xFF,
0xF0,
0xA3,
0x74,
0x80,
0xF0,
0xA3,
0xF0,
0xA3,
0x74,
0xFF,
0xF0,
0x75,
0x0D,
0x01,
0x80,
0x03,
0xE4,
0xF5,
0x0D,
0x12,
0x0D,
0x57,
0x22,
0xE4,
0xF5,
0x4E,
0x75,
0x40,
0x80,
0x75,
0x3B,
0x2C,
0x75,
0x4B,
0x18,
0xF5,
0x35,
0x75,
0x36,
0x7C,
0x75,
0x49,
0x01,
0xF5,
0x4A,
0x75,
0x4C,
0x02,
0x75,
0x4D,
0x68,
0x90,
0x3F,
0x07,
0xE0,
0x75,
0xF0,
0x04,
0xA4,
0xF5,
0x42,
0x85,
0xF0,
0x41,
0x90,
0x3F,
0x00,
0xE0,
0x30,
0xE7,
0x06,
0xE0,
0xF5,
0x0C,
0x12,
0x06,
0x60,
0x90,
0x3F,
0x01,
0xE5,
0x40,
0xF0,
0xE4,
0xF5,
0x47,
0xF5,
0x48,
0x85,
0x47,
0x0C,
0x85,
0x48,
0x0D,
0xF5,
0x0E,
0xF5,
0x0F,
0x12,
0x0B,
0x21,
0x50,
0x03,
0xE4,
0xF5,
0x40,
0xE4,
0xF5,
0x4E,
0x90,
0x3F,
0x01,
0xE5,
0x40,
0xF0,
0x22,
0xC2,
0x8C,
0x75,
0x89,
0x03,
0x90,
0x31,
0x00,
0xE0,
0x54,
0xFE,
0xF0,
0xE0,
0x54,
0xFD,
0xF0,
0xA3,
0xE4,
0xF0,
0x90,
0x33,
0xB0,
0xF0,
0xA3,
0x04,
0xF0,
0xA3,
0xF0,
0x90,
0x33,
0x00,
0x74,
0x13,
0xF0,
0xD2,
0x09,
0x12,
0x0C,
0xFA,
0x90,
0x30,
0xB2,
0xE0,
0x44,
0x10,
0xF0,
0x90,
0x30,
0xB4,
0xE0,
0xF5,
0x20,
0x90,
0x39,
0x01,
0x74,
0x35,
0xF0,
0x90,
0x39,
0x00,
0x74,
0x20,
0xF0,
0x90,
0x37,
0x00,
0x74,
0xFF,
0xF0,
0xA3,
0xF0,
0x90,
0x37,
0x00,
0xE0,
0x54,
0xF7,
0xF0,
0xE0,
0x54,
0xEF,
0xF0,
0x75,
0xA8,
0x87,
0x22,
0x85,
0x0C,
0x10,
0x85,
0x0D,
0x11,
0xE5,
0x0F,
0x24,
0x2C,
0xFF,
0xE4,
0x35,
0x0E,
0xFE,
0xD3,
0xE5,
0x11,
0x9F,
0xE5,
0x10,
0x9E,
0x40,
0x1F,
0x74,
0xE8,
0x25,
0x11,
0xF5,
0x11,
0x74,
0xFF,
0x35,
0x10,
0xF5,
0x10,
0xF5,
0x12,
0x85,
0x11,
0x13,
0x12,
0x0B,
0x66,
0x40,
0x01,
0x22,
0x75,
0x12,
0x02,
0x12,
0x0D,
0x3D,
0x80,
0xCF,
0x85,
0x0E,
0x12,
0x85,
0x0F,
0x13,
0x12,
0x0B,
0x66,
0x40,
0x01,
0x22,
0xD3,
0x22,
0xE5,
0x12,
0x54,
0x03,
0xFC,
0xAD,
0x13,
0xED,
0xC4,
0xF8,
0x54,
0x0F,
0xC8,
0x68,
0xFF,
0xEC,
0xC4,
0x54,
0xF0,
0x48,
0xAB,
0x07,
0xFA,
0xEC,
0x90,
0x3F,
0x05,
0xF0,
0xA3,
0xE5,
0x13,
0xF0,
0x45,
0x12,
0x70,
0x03,
0x7A,
0x80,
0xFB,
0x8A,
0x14,
0x8B,
0x15,
0x12,
0x0B,
0xA2,
0x40,
0x01,
0x22,
0xE5,
0x12,
0x54,
0x03,
0xF5,
0x5B,
0x85,
0x13,
0x5C,
0xD3,
0x22,
0xE4,
0xF5,
0x16,
0x12,
0x0C,
0x13,
0x75,
0x17,
0x18,
0x12,
0x09,
0x21,
0x40,
0x02,
0x80,
0x14,
0xE5,
0x14,
0xF5,
0x17,
0x12,
0x09,
0x21,
0x40,
0x02,
0x80,
0x09,
0xE5,
0x15,
0xF5,
0x17,
0x12,
0x09,
0x21,
0x40,
0x05,
0x12,
0x0C,
0x49,
0x80,
0x05,
0x12,
0x0C,
0x49,
0xD3,
0x22,
0x05,
0x16,
0xE5,
0x16,
0xC3,
0x94,
0x0A,
0x40,
0xCC,
0xC3,
0x22,
0x12,
0x0A,
0xCA,
0x12,
0x0A,
0x6D,
0x12,
0x04,
0xF1,
0x12,
0x03,
0xC2,
0x30,
0x0A,
0xF7,
0xE5,
0x40,
0x54,
0x03,
0xFF,
0xBF,
0x01,
0x05,
0x12,
0x00,
0x06,
0x80,
0x18,
0xE5,
0x40,
0x64,
0x4A,
0x60,
0x05,
0xE5,
0x40,
0xB4,
0xCA,
0x05,
0x12,
0x08,
0x14,
0x80,
0x08,
0xE5,
0x40,
0xB4,
0x4E,
0x03,
0x12,
0x0C,
0xAC,
0xC2,
0x0A,
0x80,
0xCE,
0xE4,
0xF5,
0xA8,
0xD2,
0x01,
0xD2,
0x00,
0x90,
0x30,
0xB4,
0xE5,
0x20,
0xF0,
0x7F,
0x0A,
0xAE,
0x07,
0x1F,
0xEE,
0x70,
0xFA,
0xC2,
0x01,
0x90,
0x30,
0xB4,
0xE5,
0x20,
0xF0,
0x7F,
0x05,
0xAE,
0x07,
0x1F,
0xEE,
0x70,
0xFA,
0xC2,
0x00,
0x90,
0x30,
0xB4,
0xE5,
0x20,
0xF0,
0x7F,
0x05,
0xAE,
0x07,
0x1F,
0xEE,
0x70,
0xFA,
0x22,
0xC2,
0x01,
0x90,
0x30,
0xB4,
0xE5,
0x20,
0xF0,
0x7F,
0x05,
0xAE,
0x07,
0x1F,
0xEE,
0x70,
0xFA,
0xD2,
0x00,
0x90,
0x30,
0xB4,
0xE5,
0x20,
0xF0,
0x7F,
0x05,
0xAE,
0x07,
0x1F,
0xEE,
0x70,
0xFA,
0xD2,
0x01,
0x90,
0x30,
0xB4,
0xE5,
0x20,
0xF0,
0x75,
0xA8,
0x87,
0x7F,
0x05,
0xAE,
0x07,
0x1F,
0xEE,
0x70,
0xFA,
0x22,
0xE4,
0xF5,
0x59,
0xF5,
0x5A,
0x12,
0x0C,
0x13,
0x75,
0x17,
0x18,
0x12,
0x09,
0x21,
0x40,
0x02,
0x80,
0x08,
0x85,
0x58,
0x17,
0x12,
0x09,
0x21,
0x40,
0x05,
0x12,
0x0C,
0x49,
0x80,
0x05,
0x12,
0x0C,
0x49,
0xD3,
0x22,
0x05,
0x5A,
0xE5,
0x5A,
0xC3,
0x94,
0x0A,
0x40,
0xD8,
0xC3,
0x22,
0x90,
0x3F,
0x05,
0xE0,
0xFF,
0x7E,
0x00,
0x7F,
0x00,
0xFE,
0xA3,
0xE0,
0x2F,
0xFF,
0xE4,
0x3E,
0xFE,
0xE5,
0x48,
0x6F,
0x70,
0x03,
0xE5,
0x47,
0x6E,
0x60,
0x0D,
0x8E,
0x47,
0x8F,
0x48,
0x85,
0x47,
0x12,
0x85,
0x48,
0x13,
0x12,
0x0B,
0x66,
0x22,
0x90,
0x30,
0x1B,
0xE0,
0xF5,
0x0B,
0xFF,
0xC3,
0xE5,
0x4F,
0x9F,
0xFF,
0xE4,
0x94,
0x00,
0xFE,
0x12,
0x0D,
0x6B,
0xD3,
0xEF,
0x94,
0x05,
0xEE,
0x64,
0x80,
0x94,
0x80,
0x40,
0x05,
0x85,
0x0B,
0x4F,
0xD3,
0x22,
0xC3,
0x22,
0x90,
0x30,
0xB2,
0xE0,
0x44,
0x18,
0xF0,
0x90,
0x30,
0xB0,
0xE0,
0x44,
0x03,
0xF0,
0xA3,
0xE0,
0x44,
0xC0,
0xF0,
0x90,
0x30,
0xB4,
0xE0,
0x44,
0x0F,
0xF0,
0xE0,
0x54,
0xF7,
0xF0,
0xE0,
0x54,
0xFB,
0xF0,
0x22,
0x90,
0x30,
0x14,
0xE0,
0x30,
0x08,
0x10,
0x54,
0xF7,
0xF0,
0xA3,
0xE0,
0x54,
0xBF,
0xF0,
0x90,
0x30,
0x2D,
0xE4,
0xF0,
0xA3,
0xF0,
0x22,
0x44,
0x08,
0xF0,
0xA3,
0xE0,
0x44,
0x40,
0xF0,
0x22,
0xE4,
0xFF,
0xEF,
0xC3,
0x95,
0x12,
0x50,
0x11,
0x7D,
0x82,
0x7C,
0x00,
0xED,
0x1D,
0xAA,
0x04,
0x70,
0x01,
0x1C,
0x4A,
0x70,
0xF6,
0x0F,
0x80,
0xE9,
0x22,
0x30,
0x09,
0x10,
0xE5,
0x0D,
0x90,
0x33,
0x00,
0x60,
0x05,
0xE0,
0x44,
0x40,
0xF0,
0x22,
0xE0,
0x54,
0xBF,
0xF0,
0x22,
0xC3,
0xEE,
0x64,
0x80,
0x94,
0x80,
0x40,
0x02,
0x80,
0x07,
0xC3,
0xE4,
0x9F,
0xFF,
0xE4,
0x9E,
0xFE,
0x22,
0x01,
0x4F,
0x00,
0x01,
0x24,
0x00,
0x01,
0x31,
0x00,
0x01,
0x32,
0x00,
0x02,
0x33,
0x00,
0x00,
0x00,
};
static struct ov3640_ctrl *ov3640_ctrl;

static DECLARE_WAIT_QUEUE_HEAD(ov3640_wait_queue);
DECLARE_MUTEX(ov3640_sem);
static int16_t ov3640_effect = CAMERA_EFFECT_OFF;

extern int qci_read_hw_id(void);

/*=============================================================
	EXTERNAL DECLARATIONS
==============================================================*/
extern struct ov3640_reg ov3640_regs;


/*=============================================================*/

static int ov3640_reset(const struct msm_camera_sensor_info *dev)
{
	int rc = 0;
       gpio_direction_output(1, 0);
	rc = gpio_request(dev->sensor_reset, "ov3640");
	if (!rc) {
		rc = gpio_direction_output(dev->sensor_reset, 0);
		mdelay(20);
		rc = gpio_direction_output(dev->sensor_reset, 1);
	}

	gpio_free(dev->sensor_reset);
	return rc;
}

static int32_t ov3640_i2c_txdata(unsigned short saddr,
	unsigned char *txdata, int length)
{
	struct i2c_msg msg[] = {
		{
			.addr = saddr,
			.flags = 0,
			.len = length,
			.buf = txdata,
		},
	};

	if (i2c_transfer(ov3640_client->adapter, msg, 1) < 0) {
		CDBG("ov3640_i2c_txdata failed\n");
		return -EIO;
	}

	return 0;
}

static int32_t ov3640_i2c_write(unsigned short saddr,
	unsigned short waddr, unsigned short wdata, enum ov3640_width width)
{
	int32_t rc = -EIO;
	unsigned char buf[4];

	memset(buf, 0, sizeof(buf));
	switch (width) {
	case WORD_LEN: {
		buf[0] = (waddr & 0xFF00)>>8;
		buf[1] = (waddr & 0x00FF);
		buf[2] = (wdata & 0xFF00)>>8;
		buf[3] = (wdata & 0x00FF);

		rc = ov3640_i2c_txdata(saddr, buf, 4);
	}
		break;

	case BYTE_LEN: {
		buf[0] = waddr;
		buf[1] = wdata;
		rc = ov3640_i2c_txdata(saddr, buf, 2);
	}
		break;

	case WORD_ADDR_BYTE_LEN: {
		buf[0] = (waddr & 0xFF00)>>8;
		buf[1] = (waddr & 0x00FF);
		buf[2] = wdata;

		rc = ov3640_i2c_txdata(saddr, buf, 3);
	}
		break;

	default:
		break;
	}

	if (rc < 0)
		CDBG(
		"i2c_write failed, addr = 0x%x, val = 0x%x!\n",
		waddr, wdata);

	return rc;
}

static int32_t ov3640_i2c_write_table(
	struct ov3640_i2c_reg_conf const *reg_conf_tbl,
	int num_of_items_in_table)
{
	int i;
	int32_t rc = -EIO;

	for (i = 0; i < num_of_items_in_table; i++) {
		rc = ov3640_i2c_write(ov3640_client->addr,
			reg_conf_tbl->waddr, reg_conf_tbl->wdata,
			reg_conf_tbl->width);
		if (rc < 0)
			break;
		if (reg_conf_tbl->mdelay_time != 0)
			mdelay(reg_conf_tbl->mdelay_time);
		reg_conf_tbl++;
	}

	return rc;
}
static int ov3640_i2c_rxdata(unsigned short saddr,
	unsigned char *rxdata, int length)
{
	struct i2c_msg msgs[] = {
	{
		.addr   = saddr,
		.flags = 0,
		.len   = 2,
		.buf   = rxdata,
	},
	{
		.addr   = saddr,
		.flags = I2C_M_RD,
		.len   = length,
		.buf   = rxdata,
	},
	};

	if (i2c_transfer(ov3640_client->adapter, msgs, 2) < 0) {
		CDBG("ov3640_i2c_rxdata failed!\n");
		return -EIO;
	}

	return 0;
}

static int32_t ov3640_i2c_read(unsigned short   saddr,
	unsigned short raddr, unsigned short *rdata, enum ov3640_width width)
{
	int32_t rc = 0;
	unsigned char buf[4];

	if (!rdata)
		return -EIO;

	memset(buf, 0, sizeof(buf));

	switch (width) {
	case WORD_LEN: {
		buf[0] = (raddr & 0xFF00)>>8;
		buf[1] = (raddr & 0x00FF);

		rc = ov3640_i2c_rxdata(saddr, buf, 2);
		if (rc < 0)
			return rc;

		*rdata = buf[0] << 8 | buf[1];
	}
		break;

	case WORD_ADDR_BYTE_LEN: {
		buf[0] = (raddr & 0xFF00)>>8;
		buf[1] = (raddr & 0x00FF);

		rc = ov3640_i2c_rxdata(saddr, buf, 1);
		if (rc < 0)
			return rc;

		*rdata = buf[0] ;
	}
		break;

	default:
		break;
	}

	if (rc < 0)
		CDBG("ov3640_i2c_read failed!\n");

	return rc;
}


static long ov3640_reg_init(void)
{
	int32_t array_length;
	int32_t i;
	long rc;
	u_int32_t pcbid;

	array_length = ov3640_regs.prev_snap_reg_settings_size;
	/* Configure sensor for Preview mode and Snapshot mode */
	for (i = 0; i < array_length; i++) {
		rc = ov3640_i2c_write(ov3640_client->addr,
		  ov3640_regs.prev_snap_reg_settings[i].register_address,
		  ov3640_regs.prev_snap_reg_settings[i].register_value,
		  WORD_ADDR_BYTE_LEN);

		if (rc < 0)
			return rc;
	}
        pcbid = qci_read_hw_id();
        if(pcbid>=2)
        {       
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x30b2, 0x10,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x300e, 0x32,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
        }
		rc = ov3640_i2c_write(ov3640_client->addr,
		  0x308C,0x00,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3104,0x02,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3105,0xFF,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3106,0x00,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3107,0xFF,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
        if (autofocus_firmware_download==1)
        {
	array_length = ARRAY_SIZE(ov3640_auto_focus_reg_firmware_array);
	i2c_master_send(ov3640_client, ov3640_auto_focus_reg_firmware_array, array_length);
        }
        autofocus_firmware_download =1;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3F00,0x94,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3F01,0x1e,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3F02,0x64,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3F03,0xc8,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;

	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3F04,0x03,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3F05,0x84,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3F06,0x00,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3F07,0x20,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3104,0x00,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
      rc = ov3640_i2c_write(ov3640_client->addr,  0x3F00,0x02, WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
     rc = ov3640_i2c_write(ov3640_client->addr,  0x3F00,0x02, WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
     rc = ov3640_i2c_write(ov3640_client->addr,  0x3F00,0x02, WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	return 0;
}

static long ov3640_set_effect(int mode, int effect)
{
	uint16_t reg_addr;
	uint16_t reg_val;
	long rc = 0;
       #if 1
	switch (mode) {
	case SENSOR_PREVIEW_MODE:
		/* Context A Special Effects */
		break;

	case SENSOR_SNAPSHOT_MODE:
		/* Context B Special Effects */
		break;

	default:
		reg_addr = 0x2799;
		break;
	}

	switch (effect) {
	case CAMERA_EFFECT_OFF: {
        RegAddrVal_3355=(RegAddrVal_3355&(~0x58))|0x00;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3355,RegAddrVal_3355,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	}
			break;

	case CAMERA_EFFECT_MONO: {
       RegAddrVal_3302=(RegAddrVal_3302&(~0x80))|0x80;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3302,RegAddrVal_3302,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
       RegAddrVal_3355=(RegAddrVal_3355&(~0x58))|0x18;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3355,RegAddrVal_3355,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x335a,0x80,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x335b,0x80,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	}
		break;

	case CAMERA_EFFECT_NEGATIVE: {
        RegAddrVal_3302=(RegAddrVal_3302&(~0x80))|0x80;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3302,RegAddrVal_3302,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
        RegAddrVal_3355=(RegAddrVal_3355&(~0x58))|0x40;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3355,RegAddrVal_3355,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	}
		break;


	case CAMERA_EFFECT_SEPIA: {
        RegAddrVal_3302=(RegAddrVal_3302&(~0x80))|0x80;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3302,RegAddrVal_3302,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
        RegAddrVal_3355=(RegAddrVal_3355&(~0x58))|0x18;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3355,RegAddrVal_3355,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x335a,0x40,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x335b,0xa0,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	}
		break;
	case CAMERA_EFFECT_BLUISH: {
        RegAddrVal_3302=(RegAddrVal_3302&(~0x80))|0x80;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3302,RegAddrVal_3302,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
        RegAddrVal_3355=(RegAddrVal_3355&(~0x58))|0x18;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3355,RegAddrVal_3355,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x335a,0xa0,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x335b,0x40,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;

	}
		break;
	case CAMERA_EFFECT_REDDISH: {
        RegAddrVal_3302=(RegAddrVal_3302&(~0x80))|0x80;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3302,RegAddrVal_3302,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
        RegAddrVal_3355=(RegAddrVal_3355&(~0x58))|0x18;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3355,RegAddrVal_3355,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x335a,0x80,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x335b,0xc0,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;

	}
		break;
	case CAMERA_EFFECT_GREENISH: {
        RegAddrVal_3302=(RegAddrVal_3302&(~0x80))|0x80;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3302,RegAddrVal_3302,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
        RegAddrVal_3355=(RegAddrVal_3355&(~0x58))|0x18;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3355,RegAddrVal_3355,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x335a,0x60,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x335b,0x60,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;

	}
		break;
	default: {
		return -EINVAL;
	}
	}
	ov3640_effect = effect;
	/* Refresh Sequencer */
       #endif
	return rc;
}
static long ov3640_set_exposure_mode(int mode)
{
	uint16_t reg_addr;
	uint16_t reg_val;
	long rc = 0;
       #if 1
	switch (mode) {
	case CAMERA_AEC_FRAME_AVERAGE: {
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x303c,0x08,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x303d,0x18,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x303e,0x06,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x303f,0x0c,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3030,0x11,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3031,0x11,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3032,0x11,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3033,0x11,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3034,0x11,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3035,0x11,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3036,0x11,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3037,0x11,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	}
			break;
	case CAMERA_AEC_CENTER_WEIGHTED: {
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x303c,0x08,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x303d,0x18,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x303e,0x06,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x303f,0x0c,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3030,0x62,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3031,0x26,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3032,0xe6,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3033,0x6e,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3034,0xea,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3035,0xae,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3036,0xa6,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3037,0x6a,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	}
	case CAMERA_AEC_SPOT_METERING: {
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x303c,0x08,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x303d,0x18,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x303e,0x06,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x303f,0x0c,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3030,0x11,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3031,0x11,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3032,0xf1,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3033,0x1f,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3034,0xf1,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3035,0x1f,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3036,0x11,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3037,0x11,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	}
		break;
	default: {
	}
	}
	//ov3640_effect = effect;
	/* Refresh Sequencer */
       #endif
	return rc;
}

static long ov3640_set_antibanding(int antibanding)
{
	uint16_t reg_addr;
	uint16_t reg_val;
	long rc = 0;
	switch (antibanding) {
	case CAMERA_ANTIBANDING_AUTO: {
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x304d,0x45,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
       RegAddrVal_30d7=(RegAddrVal_30d7&(~0x10))|0x10;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x30d7,RegAddrVal_30d7,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x302c,0x00,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x302d,0x00,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x302e,0x00,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
       RegAddrVal_3014=(RegAddrVal_3014&(~0x40))|0x40;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3014,RegAddrVal_3014,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3048,0x1f,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3049,0x4e,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x304a,0x20,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x304b,0x00,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
       RegAddrVal_304c=(RegAddrVal_304c&(~0x80))|0x80;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x304c,RegAddrVal_304c,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x30a5,0x03,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x30ab,0x03,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	}
			break;
	case CAMERA_ANTIBANDING_50HZ: {
       RegAddrVal_3014=(RegAddrVal_3014&(~0x80))|0xc0;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3014,RegAddrVal_3014,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
       RegAddrVal_3013=(RegAddrVal_3013&(~0x20))|0x20;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3013,RegAddrVal_3013,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	}
		break;
	case CAMERA_ANTIBANDING_60HZ: {
       RegAddrVal_3014=(RegAddrVal_3014&(~0x00))|0xc0;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3014,RegAddrVal_3014,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
       RegAddrVal_3013=(RegAddrVal_3013&(~0x20))|0x20;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3013,RegAddrVal_3013,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	}
		break;
	default: {
	}
	}
	/* Refresh Sequencer */
	return rc;
}

static long ov3640_set_wb(int wb)
{
	uint16_t reg_addr;
	uint16_t reg_val;
	long rc = 0;
	switch (wb) {
	case CAMERA_WB_AUTO: {
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x332b,0x00,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	}
			break;
	case CAMERA_WB_INCANDESCENT: {
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x332b,0x08,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x33a7,0x40,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x33a8,0x40,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x33a9,0x64,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	}
		break;
	case CAMERA_WB_FLUORESCENT: {
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x332b,0x08,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x33a7,0x52,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x33a8,0x40,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x33a9,0x5a,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	}
		break;
	case CAMERA_WB_DAYLIGHT: {
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x332b,0x08,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x33a7,0x5a,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x33a8,0x40,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x33a9,0x48,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	}
		break;
	case CAMERA_WB_CLOUDY_DAYLIGHT: {
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x332b,0x08,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x33a7,0x68,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x33a8,0x40,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x33a9,0x5a,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	}
		break;
	case CAMERA_WB_TWILIGHT: {
	}
		break;
	case CAMERA_WB_SHADE: {
	}
		break;
	default: {
	}
	}
	//ov3640_effect = effect;
	/* Refresh Sequencer */
	return rc;
}

static long ov3640_set_brightness(int brightness)
{
	uint16_t reg_addr;
	uint16_t reg_val;
	long rc = 0;
	switch (brightness) {
	case 0: {
       RegAddrVal_3302=(RegAddrVal_3302&(~0x80))|0x80;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3302,RegAddrVal_3302,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x335e,0x30,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
       RegAddrVal_3355=(RegAddrVal_3355&(~0x04))|0x04;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3355,RegAddrVal_3355,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
       RegAddrVal_3354=(RegAddrVal_3354&(~0x08))|0x08;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3354,RegAddrVal_3354,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	}
			break;
	case 1: {
       RegAddrVal_3302=(RegAddrVal_3302&(~0x80))|0x80;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3302,RegAddrVal_3302,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x335e,0x20,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
       RegAddrVal_3355=(RegAddrVal_3355&(~0x04))|0x04;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3355,RegAddrVal_3355,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
       RegAddrVal_3354=(RegAddrVal_3354&(~0x08))|0x08;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3354,RegAddrVal_3354,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	}
		break;
	case 2: {
       RegAddrVal_3302=(RegAddrVal_3302&(~0x80))|0x80;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3302,RegAddrVal_3302,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x335e,0x10,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
       RegAddrVal_3355=(RegAddrVal_3355&(~0x04))|0x04;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3355,RegAddrVal_3355,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
       RegAddrVal_3354=(RegAddrVal_3354&(~0x08))|0x08;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3354,RegAddrVal_3354,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	}
		break;
	case 3: {
       RegAddrVal_3302=(RegAddrVal_3302&(~0x80))|0x80;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3302,RegAddrVal_3302,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x335e,0x00,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
       RegAddrVal_3355=(RegAddrVal_3355&(~0x04))|0x04;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3355,RegAddrVal_3355,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
       RegAddrVal_3354=(RegAddrVal_3354&(~0x08))|0x00;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3354,RegAddrVal_3354,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	}
		break;
	case 4: {
       RegAddrVal_3302=(RegAddrVal_3302&(~0x80))|0x80;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3302,RegAddrVal_3302,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x335e,0x10,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
       RegAddrVal_3355=(RegAddrVal_3355&(~0x04))|0x04;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3355,RegAddrVal_3355,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
       RegAddrVal_3354=(RegAddrVal_3354&(~0x08))|0x00;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3354,RegAddrVal_3354,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	}
		break;
	case 5: {
       RegAddrVal_3302=(RegAddrVal_3302&(~0x80))|0x80;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3302,RegAddrVal_3302,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x335e,0x20,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
       RegAddrVal_3355=(RegAddrVal_3355&(~0x04))|0x04;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3355,RegAddrVal_3355,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
       RegAddrVal_3354=(RegAddrVal_3354&(~0x08))|0x00;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3354,RegAddrVal_3354,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	}
		break;
	case 6: {
       RegAddrVal_3302=(RegAddrVal_3302&(~0x80))|0x80;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3302,RegAddrVal_3302,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x335e,0x30,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
       RegAddrVal_3355=(RegAddrVal_3355&(~0x04))|0x04;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3355,RegAddrVal_3355,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
       RegAddrVal_3354=(RegAddrVal_3354&(~0x08))|0x00;
	rc = ov3640_i2c_write(ov3640_client->addr,
		  0x3354,RegAddrVal_3354,WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	}
		break;
	default: {
	}
	}

	/* Refresh Sequencer */
	return rc;
}

static long ov3640_set_af(int mode)
{
	int32_t array_length;
	int32_t i;
	uint16_t clock;
	long rc = 0;
	switch (mode) {
	case SENSOR_PREVIEW_MODE:
		mdelay(5);
		return -EFAULT;
		break;

	case SENSOR_SNAPSHOT_MODE:
	rc = ov3640_i2c_write(ov3640_client->addr,  0x3F00,0x08, WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,  0x3F00,0x08, WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,  0x3F00,0x08, WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	mdelay(5);	
	rc = ov3640_i2c_write(ov3640_client->addr,  0x3F00,0x02, WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,  0x3F00,0x02, WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,  0x3F00,0x02, WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	mdelay(5);	
	rc = ov3640_i2c_write(ov3640_client->addr,  0x3F00,0x03, WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,  0x3F00,0x03, WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,  0x3F00,0x03, WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
		mdelay(5);
		break;

	default:
		return -EFAULT;
	}

	return 0;
}
static long ov3640_cancel_af(int mode)
{
	int32_t array_length;
	int32_t i;
	uint16_t clock;
	long rc = 0;
	switch (mode) {
	case SENSOR_PREVIEW_MODE:
		mdelay(5);
		return -EFAULT;
		break;

	case SENSOR_SNAPSHOT_MODE:
	rc = ov3640_i2c_write(ov3640_client->addr,  0x3F00,0x06, WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,  0x3F00,0x06, WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
	rc = ov3640_i2c_write(ov3640_client->addr,  0x3F00,0x06, WORD_ADDR_BYTE_LEN);
		if (rc < 0)
			return rc;
		mdelay(5);
		break;

	default:
		return -EFAULT;
	}

	return 0;
}
static long ov3640_set_sensor_mode(int mode)
{
	uint16_t clock;
	long rc = 0;
       int32_t array_length;
       int32_t i;      
	switch (mode) {
	case SENSOR_PREVIEW_MODE:
		
	array_length = ov3640_regs.prev_reg_settings_size;
  
	/* Configure sensor for Preview mode and Snapshot mode */
	for (i = 0; i < array_length; i++) {
		rc = ov3640_i2c_write(ov3640_client->addr,
		  ov3640_regs.prev_reg_settings[i].register_address,
		  ov3640_regs.prev_reg_settings[i].register_value,
		  WORD_ADDR_BYTE_LEN);

		if (rc < 0)
			return rc;
	}
	mdelay(50);
		break;

	case SENSOR_SNAPSHOT_MODE:
	array_length = ov3640_regs.snap_reg_settings_size;


	/* Configure sensor for Preview mode and Snapshot mode */
	for (i = 0; i < array_length; i++) {
		rc = ov3640_i2c_write(ov3640_client->addr,
		  ov3640_regs.snap_reg_settings[i].register_address,
		  ov3640_regs.snap_reg_settings[i].register_value,
		  WORD_ADDR_BYTE_LEN);

		if (rc < 0)
			return rc;
	}

		mdelay(5);
		break;

	case SENSOR_RAW_SNAPSHOT_MODE:
	array_length = ov3640_regs.snap_reg_settings_size;


	/* Configure sensor for Preview mode and Snapshot mode */
	for (i = 0; i < array_length; i++) {
		rc = ov3640_i2c_write(ov3640_client->addr,
		  ov3640_regs.snap_reg_settings[i].register_address,
		  ov3640_regs.snap_reg_settings[i].register_value,
		  WORD_ADDR_BYTE_LEN);

		if (rc < 0)
			return rc;
	}

		mdelay(5);
		break;

	default:
		return -EINVAL;
	}

	return 0;
}

static int ov3640_sensor_init_probe(const struct msm_camera_sensor_info *data)
{
	uint16_t model_id = 0;
	int rc = 0;
	CDBG("init entry \n");
	rc = ov3640_reset(data);
	if (rc < 0) {
		CDBG("reset failed!\n");
		goto init_probe_fail;
	}

	rc = ov3640_reg_init();
	if (rc < 0)
		goto init_probe_fail;

	return rc;

init_probe_fail:
	return rc;
}

int ov3640_sensor_init(const struct msm_camera_sensor_info *data)
{
	int rc = 0;
	ov3640_ctrl = kzalloc(sizeof(struct ov3640_ctrl), GFP_KERNEL);
	if (!ov3640_ctrl) {
		CDBG("ov3640_init failed!\n");
		rc = -ENOMEM;
		goto init_done;
	}
       preview_flag = 0;
	if (data)
		ov3640_ctrl->sensordata = data;

	/* Input MCLK = 24MHz */
	msm_camio_clk_rate_set(24000000);
	mdelay(5);

	msm_camio_camif_pad_reg_reset();

	rc = ov3640_sensor_init_probe(data);
	if (rc < 0) {
		CDBG("ov3640_sensor_init failed!\n");
		goto init_fail;
	}

init_done:
	return rc;

init_fail:
	kfree(ov3640_ctrl);
	return rc;
}

static int ov3640_init_client(struct i2c_client *client)
{
	/* Initialize the MSM_CAMI2C Chip */
	init_waitqueue_head(&ov3640_wait_queue);
	return 0;
}

int ov3640_sensor_config(void __user *argp)
{
	struct sensor_cfg_data cfg_data;
	long   rc = 0;
	if (copy_from_user(&cfg_data,
			(void *)argp,
			sizeof(struct sensor_cfg_data)))
		return -EFAULT;

	/* down(&ov3640_sem); */
        printk("isaac, ov3640_sensor_config, cfgtype = %d, effect = %d\n",
		cfg_data.cfgtype, cfg_data.cfg.effect);
	CDBG("ov3640_ioctl, cfgtype = %d, mode = %d\n",
		cfg_data.cfgtype, cfg_data.mode);
		switch (cfg_data.cfgtype) {
		case CFG_SET_MODE:
			rc = ov3640_set_sensor_mode(
						cfg_data.mode);
			break;

		case CFG_SET_EFFECT:
			rc = ov3640_set_effect(cfg_data.mode,
						cfg_data.cfg.effect);
			break;
		case CFG_SET_WB:
			rc = ov3640_set_wb(cfg_data.cfg.effect);
			break;
		case CFG_SET_ANTIBANDING:
			rc = ov3640_set_antibanding(cfg_data.cfg.effect);
			break;
   		case CFG_SET_EXPOSURE_MODE:
			rc = ov3640_set_exposure_mode(cfg_data.cfg.effect);
			break;
	        case QCI_CFG_SET_AF:
		        rc=ov3640_set_af(cfg_data.mode);
	        break;
	        case QCI_CFG_CANCEL_AF:
		        rc=ov3640_cancel_af(cfg_data.mode);
	        break;
		case CFG_SET_BRIGHTNESS:
			rc = ov3640_set_brightness(cfg_data.cfg.effect);
			break;
		case CFG_GET_AF_MAX_STEPS:
		default:
			rc = -EINVAL;
			break;
		}

	/* up(&ov3640_sem); */
       
	return rc;
}

int ov3640_sensor_release(void)
{
	int rc = 0;
	/* down(&ov3640_sem); */
	preview_flag = 0;
        gpio_direction_output(1, 1);
	kfree(ov3640_ctrl);
	/* up(&ov3640_sem); */

	return rc;
}

static int ov3640_i2c_probe(struct i2c_client *client,
	const struct i2c_device_id *id)
{
	int rc = 0;
	if (!i2c_check_functionality(client->adapter, I2C_FUNC_I2C)) {
		rc = -ENOTSUPP;
		goto probe_failure;
	}
        
	ov3640_sensorw =
		kzalloc(sizeof(struct ov3640_work), GFP_KERNEL);

	if (!ov3640_sensorw) {
		rc = -ENOMEM;
		goto probe_failure;
	}

	i2c_set_clientdata(client, ov3640_sensorw);
	ov3640_init_client(client);
	ov3640_client = client;

	CDBG("ov3640_probe succeeded!\n");

	return 0;

probe_failure:
	kfree(ov3640_sensorw);
	ov3640_sensorw = NULL;
	CDBG("ov3640_probe failed!\n");
	return rc;
}

static const struct i2c_device_id ov3640_i2c_id[] = {
	{ "ov3640", 0},
	{ },
};

static struct i2c_driver ov3640_i2c_driver = {
	.id_table = ov3640_i2c_id,
	.probe  = ov3640_i2c_probe,
	.remove = __exit_p(ov3640_i2c_remove),
	.driver = {
		.name = "ov3640",
	},
};

static int ov3640_sensor_probe(const struct msm_camera_sensor_info *info,
				struct msm_sensor_ctrl *s)
{
	int rc = i2c_add_driver(&ov3640_i2c_driver);
	if (rc < 0 || ov3640_client == NULL) {
		rc = -ENOTSUPP;
		goto probe_done;
	}
	/* Input MCLK = 24MHz */
	msm_camio_clk_rate_set(24000000);
	mdelay(5);

	rc = ov3640_sensor_init_probe(info);
	if (rc < 0)
		goto probe_done;

	s->s_init = ov3640_sensor_init;
	s->s_release = ov3640_sensor_release;
	s->s_config  = ov3640_sensor_config;
        gpio_direction_output(1, 1);

probe_done:
	CDBG("%s %s:%d\n", __FILE__, __func__, __LINE__);
	return rc;
}

static int __ov3640_probe(struct platform_device *pdev)
{
	return msm_camera_drv_start(pdev, ov3640_sensor_probe);
}
static void ov3640_early_suspend(struct early_suspend *handler) {
	if(preview_flag == 1)
	{
        ov3640_i2c_write(ov3640_client->addr,0x300e,0xb8,WORD_ADDR_BYTE_LEN);
	ov3640_i2c_write(ov3640_client->addr,0x308d,0x14,WORD_ADDR_BYTE_LEN);
	ov3640_i2c_write(ov3640_client->addr,0x3086,0x0f,WORD_ADDR_BYTE_LEN);
       gpio_direction_output(1, 1);
	}

}
static void ov3640_late_resume(struct early_suspend *handler) {
	if(preview_flag == 1)
	{
       gpio_direction_output(1, 0); 
       ov3640_i2c_write(ov3640_client->addr,0x3086,0x08,WORD_ADDR_BYTE_LEN);
       ov3640_i2c_write(ov3640_client->addr,0x308d,0x14,WORD_ADDR_BYTE_LEN);
       ov3640_i2c_write(ov3640_client->addr,0x300e,0x38,WORD_ADDR_BYTE_LEN);
		}
}

static struct early_suspend ov3640_power_suspend = {
	.suspend = ov3640_early_suspend,
	.resume = ov3640_late_resume,
	.level = EARLY_SUSPEND_LEVEL_DISABLE_FB-1,
};
static struct platform_driver msm_camera_driver = {
	.probe = __ov3640_probe,
	.driver = {
		.name = "msm_camera_ov3640",
		.owner = THIS_MODULE,
	},
};

static int __init ov3640_init(void)
{
       gpio_direction_output(1, 0);
       gpio_direction_output(30, 1);
	register_early_suspend(&ov3640_power_suspend);
	return platform_driver_register(&msm_camera_driver);
}

module_init(ov3640_init);
